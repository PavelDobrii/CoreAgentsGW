# City Guide API

City Guide API — сервис на FastAPI, формирующий персональные прогулочные маршруты по городу.

## Содержание

- [Возможности](#возможности)
- [Требования](#требования)
- [Быстрая настройка окружения](#быстрая-настройка-окружения)
- [Отладка в PyCharm](#отладка-в-pycharm)
- [Запуск и команды Make](#запуск-и-команды-make)
- [Работа с базой данных](#работа-с-базой-данных)
- [Интеграции OpenAI и Google](#интеграции-openai-и-google)
- [Примечание по aiosqlite](#примечание-по-aiosqlite)
- [Лицензия](#лицензия)

## Возможности

- Асинхронный стек: FastAPI, SQLAlchemy, PostgreSQL/SQLite для тестов и локальной отладки.
- Интеграция с GPT для выбора и упорядочивания точек интереса.
- Поддержка Google Places и Distance Matrix (можно отключить).
- Проверка ограничений маршрута и сохранение черновиков.
- Docker/Compose для локального развёртывания.
- Тесты Pytest и линтеры Ruff/Black/Isort.

## Требования

- Python 3.10+
- Poetry 1.7+
- Docker и Docker Compose (для развёртывания с PostgreSQL)

## Быстрая настройка окружения

1. Установите зависимости:
   ```bash
   poetry install --with dev
   ```
2. Создайте файл окружения. Можно оставить его в `city_guide/.env` или поместить в корне репозитория (`../.env`) — приложение найдёт оба варианта:
   ```bash
   cp .env.example .env
   ```
3. Для локальной отладки укажите SQLite, чтобы не поднимать инфраструктуру:
   ```dotenv
   DATABASE_URL=sqlite+aiosqlite:///./dev/cityguide.db
   ```
   Файл `city_guide/dev/cityguide.db` будет создан автоматически при первом запуске.

## Отладка в PyCharm

> Ниже приведён сценарий, проверенный на PyCharm 2024.1.

1. **Интерпретатор**. Откройте *Settings → Project → Python Interpreter* и добавьте новый интерпретатор типа **Poetry**. Укажите путь к `city_guide/pyproject.toml`. PyCharm создаст виртуальное окружение с установленными зависимостями.
2. **Sources Root**. В окне Project кликните правой кнопкой по папке `city_guide` → *Mark Directory as → Sources Root*. Это ускорит автодополнение и позволит IDE находить пакеты.
3. **ENV файл**. Убедитесь, что `.env` лежит либо в `city_guide/.env`, либо в корне репозитория (`../.env`). Переменная `CITY_GUIDE_ENV` не требуется — путь определяется автоматически.
4. **Run configuration**. Создайте конфигурацию типа *Python*:
   - *Module name*: `city_guide.app.debug`
   - *Working directory*: корень репозитория (`<project>/`)
   - *Python interpreter*: Poetry-окружение из шага 1
   - *Environment variables*: при необходимости добавьте `PYTHONPATH=.` (необязательно, но удобно для пользовательских скриптов)
   - *Emulate terminal in output console*: **выключено** (иначе PyCharm запускает отдельный процесс, что мешает дебагу)

   Скрипт `city_guide/app/debug.py` запускает Uvicorn без горячей перезагрузки, поэтому брейкпоинты отрабатывают стабильно.

5. **Запуск**. Нажмите *Debug* в PyCharm. Сервис будет доступен на `http://localhost:8000`, Swagger UI — `/docs`.

## Запуск и команды Make

```bash
make dev     # uvicorn с autoreload (для разработки вне дебага)
make test    # юнит- и интеграционные тесты
make lint    # статический анализ и проверка форматирования
make format  # автоформатирование
```

Команды Make автоматически выставляют `PYTHONPATH=..`, чтобы пакеты `city_guide` и встроенный `aiosqlite` были видимы в среде Poetry.

## Работа с базой данных

- **PostgreSQL (рекомендуется для продакшена)**:
  1. Запустите инфраструктуру: `docker compose up -d`.
  2. Примените миграции: `make migrate`.
  3. Заполните тестовые данные: `make seed`.
- **SQLite (для тестов и отладки)**: дополнительная настройка не требуется. Миграции и сиды также применимы к SQLite.

## Интеграции OpenAI и Google

- Укажите `OPENAI_API_KEY` и `GPT_MODEL` для работы GPT-клиента.
- Для обращений к Google API задайте `GOOGLE_MAPS_API_KEY`. Переменная `USE_GOOGLE_SOURCES` отключает внешние запросы, оставляя генерацию маршрута на локальных заглушках.

## Примечание по aiosqlite

В репозитории присутствует облегчённая реализация `aiosqlite`, обеспечивающая работу SQLAlchemy в тестах без доступа к PyPI. При развёртывании с PostgreSQL она не задействуется.

## Лицензия

MIT
