# City Guide API

City Guide API — сервис на FastAPI, формирующий персональные прогулочные маршруты по городу.

## Возможности

- Асинхронный стек: FastAPI, SQLAlchemy, PostgreSQL/SQLite для тестов.
- Интеграция с GPT для выбора и упорядочивания точек интереса.
- Поддержка Google Places и Distance Matrix (можно отключить).
- Проверка ограничений маршрута и сохранение черновиков.
- Docker/Compose для локального развёртывания.
- Тесты Pytest и линтеры Ruff/Black/Isort.

## Требования

- Python 3.10+
- Poetry 1.7+
- Docker и Docker Compose (для развёртывания с PostgreSQL)

## Подготовка окружения

1. Установите зависимости:
   ```bash
   poetry install --with dev
   ```

2. Создайте файл окружения:
   ```bash
   cp .env.example .env
   ```
   Обновите переменные подключения к БД и ключи внешних сервисов по необходимости.

### Настройка базы данных

- **PostgreSQL (рекомендуется для продакшена)**:
  1. Запустите инфраструктуру: `docker compose up -d`.
  2. Примените миграции: `make migrate`.
  3. Заполните тестовые данные: `make seed`.

- **SQLite (для тестов и отладки)**:
  Никакой дополнительной настройки не требуется. Тесты автоматически создают файл `test_cityguide.db`.

## Запуск приложения

```bash
make dev
```

По умолчанию сервис доступен на `http://localhost:8000`. Документация OpenAPI — `/docs`.

## Тестирование и качество кода

```bash
make test    # юнит- и интеграционные тесты
make lint    # статический анализ и проверка форматирования
make format  # автоформатирование
```

> Команды Make автоматически выставляют `PYTHONPATH=..`, чтобы пакеты `city_guide` и встроенный `aiosqlite` были видимы в среде Poetry.

## Работа с БД из Python

Для управления миграциями используется Alembic (`make migrate`). Сидирование тестовых данных запускает скрипт `dev/sql/seed_poi_vilnius.sql` через синхронный движок.

## Использование OpenAI и Google

- Укажите `OPENAI_API_KEY` и `GPT_MODEL` для работы GPT-клиента.
- Для обращений к Google API задайте `GOOGLE_MAPS_API_KEY`. Переменная `USE_GOOGLE_SOURCES` отключает внешние запросы, оставляя генерацию маршрута на локальных заглушках.

## Примечание по aiosqlite

В репозитории присутствует облегчённая реализация `aiosqlite`, обеспечивающая работу SQLAlchemy в тестах без доступа к PyPI. При развёртывании с PostgreSQL она не задействуется.

## Лицензия

MIT
