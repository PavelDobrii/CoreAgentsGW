workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_PIPELINE_SOURCE == "web"'

stages: [build, deploy]

# Кэш ускоряет npm ci
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/

# === BUILD ===
build:
  image: node:20
  stage: build
  variables:
    # Важно: ставим devDependencies (typescript, vite и т.д.)
    NPM_CONFIG_PRODUCTION: "false"
  script:
    - node -v
    - npm ci
    # .env для Vite из CI Variables
    - printf "VITE_API_URL=%s\nVITE_GOOGLE_MAPS_API_KEY=%s\n" "$VITE_API_URL" "$VITE_GOOGLE_MAPS_API_KEY" > .env
    - npm run build   # у тебя "tsc ... && vite build"
  artifacts:
    paths:
      - dist
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# === DEPLOY ===
deploy:
  image: alpine:3.20
  stage: deploy
  needs: [build]
  environment:
    name: production
    url: https://gowee.ai
  before_script:
    - apk add --no-cache openssh-client rsync
    - eval "$(ssh-agent -s)"
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh

    # Восстанавливаем приватный ключ из base64 → файл с правами 600
    - |
      echo "$SSH_PRIVATE_KEY_B64" | base64 -d > ~/.ssh/id_ci
      sed -i 's/\r$//' ~/.ssh/id_ci
      chmod 600 ~/.ssh/id_ci
      # Проверим, что ключ валидный и без passphrase (иначе падение с понятным сообщением)
      ssh-keygen -yf ~/.ssh/id_ci >/dev/null || { echo "Invalid or ENCRYPTED private key (SSH_PRIVATE_KEY_B64)"; exit 1; }
    - ssh-add ~/.ssh/id_ci

    # known_hosts: либо из переменной, либо соберём сами
    - |
      if [ -n "$SSH_KNOWN_HOSTS" ]; then
        echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
      else
        ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
      fi

    # Быстрая проверка SSH-доступа (без интерактива)
    - ssh -o BatchMode=yes "${DEPLOY_USER}@${DEPLOY_HOST}" "echo SSH_OK"

  script:
    - REL=$(date +%Y%m%d%H%M%S)
    - RELEASE_DIR="$DEPLOY_PATH/releases/$REL"
    - echo "RELEASE_DIR=$RELEASE_DIR"

    # 1) создаём каталог релиза (БЕЗ одинарных кавычек)
    - ssh $DEPLOY_USER@$DEPLOY_HOST "mkdir -p $RELEASE_DIR"

    # 2) заливаем билд
    - rsync -az --delete dist/ $DEPLOY_USER@$DEPLOY_HOST:$RELEASE_DIR/

    # 3) переключаем симлинк и перезагружаем nginx
    - ssh $DEPLOY_USER@$DEPLOY_HOST "ln -sfn $RELEASE_DIR $DEPLOY_PATH/current && systemctl reload nginx || systemctl restart nginx"

    # 4) (опц.) показать, что всё на месте
    - ssh $DEPLOY_USER@$DEPLOY_HOST "ls -la $DEPLOY_PATH && ls -la $RELEASE_DIR"

    # 5) (опц.) чистка старых релизов
    - ssh $DEPLOY_USER@$DEPLOY_HOST "cd $DEPLOY_PATH/releases && ls -1tr | head -n -5 | xargs -r rm -rf"


  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
